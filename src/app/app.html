<div class="container">
  <header class="card" style="margin-bottom:16px;">
    <h1 style="margin:0 0 8px 0;">Percentile Tool (Angular)</h1>
    <p style="margin:0;color:#94a3b8">Phân tích log: lọc thời gian / service / error; phân vị; histogram & boxplot; xuất PNG.</p>
  </header>

  <section class="row" style="margin-bottom:16px;">
    <div class="card row-2">
      <label class="block text-sm">Chọn / kéo thả file log</label>
      <div style="display:flex; gap:8px; align-items:center; margin-top:8px;">
        <input #fileInput type="file" (change)="setFile($event.target.files?.item(0) ?? undefined)" />
        <button class="btn" (click)="fileInput.click()">Chọn file…</button>
        <span style="font-size:12px; color:#94a3b8">{{file?.name || 'Chưa có file'}}</span>
      </div>
    </div>

    <div class="card">
      <label>Field cần lấy</label>
      <input class="input" [(ngModel)]="fieldName" placeholder="duration" />
      <label style="margin-top:8px; display:block;">serviceCode</label>
      <input class="input" [(ngModel)]="serviceFilter" placeholder="VD: SERVICE_A" />
      <label style="margin-top:8px; display:block;">errorCode</label>
      <input class="input" [(ngModel)]="errorFilter" placeholder="VD: 500" />
    </div>

    <div class="card">
      <label>Khoảng thời gian</label>
      <div style="display:flex; gap:8px; margin-top:8px;">
        <input class="input" type="date" [(ngModel)]="fromDate" />
        <input class="input" type="date" [(ngModel)]="toDate" />
      </div>

      <label style="margin-top:8px; display:block;">Danh sách phân vị (%)</label>
      <input class="input" [(ngModel)]="percentiles" placeholder="25,50,75,90,95,99" />

      <label style="margin-top:8px; display:block;">Phương pháp</label>
      <select class="input" [(ngModel)]="method">
        <option value="nearest">Nearest Rank</option>
        <option value="linear">Nội suy tuyến tính</option>
      </select>

      <button class="btn" style="margin-top:12px; width:100%;" (click)="analyze()">Phân tích</button>
    </div>
  </section>

  <section class="card" *ngIf="rows.length">
    <div class="toolbar">
      <h2 style="margin:0;">Kết quả</h2>
      <div style="display:flex; gap:8px;">
        <span style="font-size:12px; color:#cbd5e1; background:#111827; border:1px solid #1f2937; padding:6px 10px; border-radius:999px;">Tổng giao dịch (hợp lệ, sau lọc): <strong>{{ totalValid | number }}</strong></span>
        <span style="font-size:12px; color:#94a3b8">Dòng JSON match: {{ totalMatched | number }} / Tổng dòng: {{ totalLines | number }}</span>
        <button class="btn btn-blue" (click)="saveChart('hist')">Lưu Histogram</button>
        <button class="btn btn-purple" (click)="saveChart('box')">Lưu Boxplot</button>
      </div>
    </div>

    <canvas #histogramCanvas height="100"></canvas>
    <canvas #boxplotCanvas height="100" style="margin-top:16px"></canvas>

    <div style="overflow:auto; margin-top:16px;">
      <table>
        <thead>
          <tr><th>Service</th><th>Percentile</th><th>Giá trị</th></tr>
        </thead>
        <tbody>
          <tr *ngFor="let r of rows">
            <td>{{r[0]}}</td>
            <td>{{r[1]}}</td>
            <td>{{r[2]}}</td>
          </tr>
        </tbody>
      </table>
    </div>
  </section>
</div>
